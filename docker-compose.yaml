services:
  # Redis service for state management and Celery broker
  redis:
    image: redis:7-alpine
    container_name: zndraw-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "6380:6379"  # Changed to 6380 to avoid conflict with existing Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - zndraw-network

  # Main ZnDraw application
  zndraw:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zndraw-app
    restart: unless-stopped
    ports:
      - "5000:5000"
    depends_on:
      redis:
        condition: service_healthy
    environment:
      # Redis configuration (enables multi-worker coordination)
      - ZNDRAW_REDIS_URL=redis://redis:6379

      # Gunicorn production settings with threaded workers
      # Sync worker: 1 worker process with multiple threads
      # threads controls concurrent connections
      # For testing: 16 concurrent threads
      # For production: increase to 100-1000 based on load
      - GUNICORN_WORKERS=1
      - GUNICORN_THREADS=16
      - GUNICORN_LOG_LEVEL=info

      # Flask secret key (CHANGE THIS IN PRODUCTION!)
      - FLASK_SECRET_KEY=change-this-to-a-random-secret-key-in-production

      # Admin access (optional - uncomment and set to enable)
      # - ZNDRAW_ADMIN_USERNAME=admin
      # - ZNDRAW_ADMIN_PASSWORD=secure-password-here

      # Upload configuration
      - ZNDRAW_UPLOAD_TEMP=/tmp/zndraw_uploads
      - ZNDRAW_MAX_UPLOAD_MB=500

      # Storage path
      - ZNDRAW_STORAGE_PATH=/app/data/zndraw-data.zarr

      # Analytics (optional)
      # - ZNDRAW_EXTENSION_ANALYTICS_TTL=604800

      # SiMGen molecular generation (optional - uncomment to enable)
      # - ZNDRAW_SIMGEN_ENABLED=true

      # File browser (optional - uncomment to enable)
      # - ZNDRAW_FILE_BROWSER_ENABLED=true
      # - ZNDRAW_FILE_BROWSER_ROOT=/app/data

      # Server URL (used by Celery tasks to connect back to main app)
      - ZNDRAW_SERVER_URL=http://zndraw:5000

      # Fix for Apple Silicon hosts
      - OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
    volumes:
      # Persistent data storage
      - ./data:/app/data
      # Upload temporary storage
      - ./uploads:/tmp/zndraw_uploads
    networks:
      - zndraw-network
    # Resource limits (adjust based on your server capacity)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '64'      # Limit to 64 cores (half of 128)
    #       memory: 256G     # Limit to 256GB (half of 500GB)
    #     reservations:
    #       cpus: '8'        # Reserve at least 8 cores
    #       memory: 16G      # Reserve at least 16GB
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000').read()"]
      interval: 30s
      timeout: 10s
      start_period: 60s  # Increased for Gunicorn startup
      retries: 3

  # Celery worker for background tasks
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zndraw-celery-worker
    restart: unless-stopped
    command: ["celery", "-A", "zndraw.app.make_celery", "worker", "--loglevel=info", "--concurrency=4"]
    depends_on:
      redis:
        condition: service_healthy
    environment:
      # Redis configuration
      - ZNDRAW_REDIS_URL=redis://redis:6379

      # Storage path (must match main app)
      - ZNDRAW_STORAGE_PATH=/app/data/zndraw-data.zarr

      # Upload configuration (must match main app)
      - ZNDRAW_UPLOAD_TEMP=/tmp/zndraw_uploads

      # Server URL (for Celery tasks to connect back to main app)
      - ZNDRAW_SERVER_URL=http://zndraw:5000

      # Fix for Apple Silicon hosts
      - OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
    volumes:
      # Share data with main app
      - ./data:/app/data
      # Share upload storage with main app
      - ./uploads:/tmp/zndraw_uploads
    networks:
      - zndraw-network
    # Resource limits for Celery worker
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '32'      # Limit to 32 cores
    #       memory: 128G    # Limit to 128GB
    #     reservations:
    #       cpus: '4'       # Reserve at least 4 cores
    #       memory: 8G      # Reserve at least 8GB
    healthcheck:
      test: ["CMD", "celery", "-A", "zndraw.app.make_celery", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

networks:
  zndraw-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
