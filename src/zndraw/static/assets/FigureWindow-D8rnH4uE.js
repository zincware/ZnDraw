import{a as me,c as fe,r as h,j as a}from"./three-D_Q1nxF1.js";import{r as be,a as xe}from"./plotly-D9v615DQ.js";import{d as ce,f as Ce,i as ve,u as V,a as je,R as ke}from"./index-CXkB7Wti.js";import{ba as Se,B as F,T as X,a as ue,b as te,d as Ae,aU as Ee,P as Te,s as _e,o as Fe,ai as Me}from"./mui-DvTeEhIk.js";import"./vendor-lXdfEqoL.js";var ze=be();const Y=me(ze);var De=xe();const Re={step:{size:12,color:"red",borderColor:"darkred",borderWidth:2},selection:{size:8,color:"rgb(100, 150, 200)",borderColor:"rgb(50, 100, 160)",borderWidth:1.5}},L=fe.memo(({windowInstance:e,allFiguresResponse:t,handleDragStart:l,handleDragStop:u,handleResizeStop:o,handleMouseDown:b,handleClose:y,handleAutocompleteChange:S,markerControls:m,children:M})=>a.jsx(ke,{size:{width:e.width,height:e.height},position:{x:e.x,y:e.y},minWidth:350,minHeight:300,style:{zIndex:e.zIndex},dragHandleClassName:"drag-handle",onDragStart:l,onDragStop:u,onResizeStop:o,bounds:".drag-boundary-container",children:a.jsxs(Te,{elevation:4,sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",overflow:"hidden"},children:[a.jsxs(F,{className:"drag-handle",onMouseDown:b,sx:{p:1,display:"flex",alignItems:"center",justifyContent:"space-between",borderBottom:1,borderColor:"divider",cursor:"move",gap:1},children:[a.jsx(_e,{options:t?.items||[],value:e.figureKey,onChange:S,disableClearable:!0,size:"small",onMouseDown:D=>D.stopPropagation(),disablePortal:!0,sx:{flexGrow:1,minWidth:150},renderInput:D=>a.jsx(Fe,{...D,label:"Figure",variant:"outlined",size:"small"})}),m,a.jsx(te,{onClick:y,size:"small",children:a.jsx(Me,{})})]}),M]})}));function re(e){if(!e)return[];if(Array.isArray(e))return e;if(typeof e=="object"&&"bdata"in e&&"dtype"in e)try{const t=De.decodeTypedArraySpec(e);if(!Array.isArray(t))return t&&typeof t=="object"&&t.length!==void 0?Array.from(t):[];if(e.shape){const u=e.shape.split(",").map(o=>Number.parseInt(o.trim()));if(u.length>=1)return de(t,u,0)}return t}catch{return[]}return[]}function de(e,t,l){if(l===t.length-1){const y=t[l];return e.slice(0,y)}const u=t[l],o=t.slice(l+1).reduce((y,S)=>y*S,1),b=[];for(let y=0;y<u;y++){const S=y*o,m=S+o,M=de(e.slice(S,m),t,l+1);b.push(M)}return b}function se(e,t){if(e==null)return;let l;if(Array.isArray(e)){const o=e[t];if(o==null)return;if(typeof o=="number")l=o;else if(Array.isArray(o))l=o[0];else if(typeof o=="object"&&o.length!==void 0&&"buffer"in o)l=o[0];else if(typeof o=="object"&&o!==null){const b=Object.keys(o).filter(y=>!isNaN(Number(y)));b.length>0&&(l=o[b[0]])}}else if(typeof e=="number")t===0&&(l=e);else if(typeof e=="object"){const o=Object.keys(e).filter(b=>!isNaN(Number(b)));if(o.length>0){const y=o.sort((S,m)=>Number(S)-Number(m))[t];y!==void 0&&(l=e[y])}}if(l==null)return;const u=Number(l);return isNaN(u)?void 0:u}function O(e,t,l=0){const u=[];if(e.customdata.length>0)for(let o=0;o<e.customdata.length;o++){const b=e.customdata[o],y=se(b,l);y!=null&&y==t&&u.push({x:e.xData[o]??o,y:e.yData[o]})}else t>=0&&t<e.yData.length&&u.push({x:e.xData[t]??t,y:e.yData[t]});return u}function pe(e,t){const l=O(e,t,e.customdataIndex);return l.length>0?l[0]:null}function Ke({windowId:e}){const[t,l]=h.useState({step:!0,selection:!0}),u=h.useRef(null),o=h.useRef([]),b=h.useRef(null),y=h.useRef(null),S=h.useRef(null),m=ce(r=>r.openWindows[e]),{updateWindowState:M,closeWindow:D,bringToFront:H,changeFigureInWindow:oe}=ce(),{data:E,isLoading:ne,isError:he,error:ye}=Ce(m?.figureKey,{enabled:!!m}),{data:K}=ve(),B=V(r=>r.updateSelectionForGeometry),J=V(r=>r.updateFrameSelection),R=V(r=>r.currentFrame),C=V(r=>r.frame_selection),q=V(r=>r.selections),{setStep:ae}=je(),{mode:ie}=Se(),T=h.useMemo(()=>{if(E?.figure?.type==="plotly"&&E.figure.data)try{return JSON.parse(E.figure.data)}catch(r){return console.error("Failed to parse Plotly JSON for figure:",{figureKey:m?.figureKey,error:r instanceof Error?r.message:String(r)}),null}return null},[E?.figure,m?.figureKey]),Q=h.useMemo(()=>{const n=ie==="dark"?{paper_bgcolor:"rgba(30, 30, 30, 1)",plot_bgcolor:"rgba(30, 30, 30, 1)",font:{color:"#e0e0e0"},xaxis:{...T?.layout?.xaxis,gridcolor:"rgba(100, 100, 100, 0.3)",zerolinecolor:"rgba(150, 150, 150, 0.5)"},yaxis:{...T?.layout?.yaxis,gridcolor:"rgba(100, 100, 100, 0.3)",zerolinecolor:"rgba(150, 150, 150, 0.5)"}}:{};return{...T?.layout,...n,autosize:!0}},[T?.layout,ie]),Z=h.useCallback(r=>{const n=new Map;let f;r.points.forEach(c=>{c.data?.meta?.interactions&&Array.isArray(c.data.meta.interactions)&&c.data.meta.interactions.forEach((i,p)=>{if(!i||!i.click)return;const d=se(c.customdata,p);d!==void 0&&(i.click==="step"?f=d:typeof i.click=="string"&&(n.has(i.click)||n.set(i.click,[]),n.get(i.click).push(d)))})}),f!==void 0&&ae(f),n.forEach((c,i)=>{B(i,c)})},[ae,B]),ee=h.useCallback(r=>{if(!r?.points)return;const n=new Map,f=[];r.points.forEach(c=>{c.data?.meta?.interactions&&Array.isArray(c.data.meta.interactions)&&c.data.meta.interactions.forEach((i,p)=>{if(!i||!i.select)return;const d=se(c.customdata,p);d!==void 0&&(i.select==="step"?f.push(d):typeof i.select=="string"&&(n.has(i.select)||n.set(i.select,[]),n.get(i.select).push(d)))})}),f.length>0&&J([...new Set(f)]),n.forEach((c,i)=>{B(i,c)})},[J,B]),le=h.useCallback(()=>{C&&C.length>0&&J([])},[C,J]);h.useEffect(()=>{if(!u.current||!T)return;const r=[],n=T.data.length;T.data.forEach((s,j)=>{if(!s.meta?.interactions)return;const A=re(s.x),z=re(s.y),g=s.customdata?re(s.customdata):[];s.meta.interactions.forEach((k,_)=>{k&&(k.click==="step"&&r.push({dataTraceIndex:j,markerTraceIndex:n+r.length,xData:A,yData:z,customdata:g,interactionType:"step",interactionKey:"step",customdataIndex:_}),(k.select==="step"||typeof k.select=="string"&&k.select!=="step")&&r.push({dataTraceIndex:j,markerTraceIndex:n+r.length,xData:A,yData:z,customdata:g,interactionType:"selection",interactionKey:k.select||"step",customdataIndex:_}))})});const f=r.map(s=>{const j=Re[s.interactionType];let A=[],z=[];if(s.interactionType==="step"){const g=pe(s,R);g&&(A=[g],z=[`<b>Current Frame</b><br>Frame: ${R}`])}else if(s.interactionType==="selection"){if(s.interactionKey==="step"&&C&&Array.isArray(C)&&C.length>0)C.forEach(g=>{if(g==null)return;O(s,g,s.customdataIndex).forEach(_=>{A.push(_),z.push(`<b>Selected Frame</b><br>Frame: ${g}`)})});else if(s.interactionKey!=="step"){const g=s.interactionKey,k=q[g];Array.isArray(k)&&k.length>0&&k.forEach(_=>{if(_==null)return;O(s,_,s.customdataIndex).forEach(ge=>{A.push(ge),z.push(`<b>Selected ${g.charAt(0).toUpperCase()+g.slice(1)}</b><br>ID: ${_}`)})})}}return{x:A.map(g=>g.x),y:A.map(g=>g.y),text:z,mode:"markers",type:"scatter",marker:{size:j.size,color:j.color,line:{color:j.borderColor,width:j.borderWidth}},showlegend:!1,hoverinfo:"text",hovertemplate:"%{text}<extra></extra>",name:`_marker_${s.interactionType}_${s.interactionKey}_${s.customdataIndex}`}}),c=f.filter(s=>s.name?.includes("_marker_selection")),i=f.filter(s=>s.name?.includes("_marker_step")),p=[...c,...i],d=new Map;p.forEach((s,j)=>{d.set(s.name||"",n+j)});const U=r.map(s=>{const j=`_marker_${s.interactionType}_${s.interactionKey}_${s.customdataIndex}`;return{...s,markerTraceIndex:d.get(j)||s.markerTraceIndex}});o.current=U;const x=[...T.data,...p];Y.react(u.current,x,Q,{responsive:!0,displayModeBar:!0});const v=u.current;return b.current=Z,y.current=ee,S.current=le,v.on("plotly_click",Z),v.on("plotly_selected",ee),v.on("plotly_deselect",le),()=>{v&&(v.removeAllListeners("plotly_click"),v.removeAllListeners("plotly_selected"),v.removeAllListeners("plotly_deselect"))}},[T,Q,Z,ee,C,q,R]),h.useEffect(()=>{if(!u.current||o.current.length===0)return;const r=o.current.filter(p=>p.interactionType==="step");if(r.length===0)return;const n=[],f=[],c=[],i=[];r.forEach(p=>{if(i.push(p.markerTraceIndex),!t.step){n.push([]),f.push([]),c.push([]);return}const d=pe(p,R);d?(n.push([d.x]),f.push([d.y]),c.push([`<b>Current Frame</b><br>Frame: ${R}`])):(n.push([]),f.push([]),c.push([]))}),Y.restyle(u.current,{x:n,y:f,text:c},i)},[R,t.step]),h.useEffect(()=>{if(!u.current||o.current.length===0)return;const r=o.current.filter(p=>p.interactionType==="selection");if(r.length===0)return;const n=[],f=[],c=[],i=[];r.forEach(p=>{if(i.push(p.markerTraceIndex),!t.selection){n.push([]),f.push([]),c.push([]);return}const d=[],U=[];if(p.interactionKey==="step"&&Array.isArray(C)&&C.length>0)C.forEach(x=>{if(x==null)return;O(p,x,p.customdataIndex).forEach(s=>{d.push(s),U.push(`<b>Selected Frame</b><br>Frame: ${x}`)})});else if(p.interactionKey!=="step"){const x=p.interactionKey,v=q[x];Array.isArray(v)&&v.length>0&&v.forEach(s=>{if(s==null)return;O(p,s,p.customdataIndex).forEach(A=>{d.push(A),U.push(`<b>Selected ${x.charAt(0).toUpperCase()+x.slice(1)}</b><br>ID: ${s}`)})})}n.push(d.map(x=>x.x)),f.push(d.map(x=>x.y)),c.push(U)}),Y.restyle(u.current,{x:n,y:f,text:c},i)},[C,q,t.selection]);const N=h.useCallback((r,n)=>{n&&oe(e,n)},[e,oe]),W=h.useCallback(()=>{H(e)},[e,H]),$=h.useCallback((r,n)=>{M(e,{x:n.x,y:n.y})},[e,M]),I=h.useCallback((r,n,f,c,i)=>{const p=f.offsetWidth,d=f.offsetHeight;M(e,{width:p,height:d,...i}),u.current&&Y.relayout(u.current,Q)},[e,M,Q]),w=h.useCallback(()=>{H(e)},[e,H]),G=h.useCallback(()=>{D(e)},[e,D]),P=h.useMemo(()=>E?.figure?.type!=="plotly"?null:a.jsxs(F,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[a.jsx(X,{variant:"caption",sx:{fontSize:"0.7rem",mr:.5},children:"Markers:"}),a.jsx(ue,{title:t.step?"Hide frame marker (red)":"Show frame marker (red)",placement:"bottom",children:a.jsx(te,{size:"small",onClick:()=>l(r=>({...r,step:!r.step})),sx:{p:.25,bgcolor:t.step?"rgba(255, 0, 0, 0.1)":"transparent",borderRadius:1,"&:hover":{bgcolor:t.step?"rgba(255, 0, 0, 0.2)":"rgba(0, 0, 0, 0.05)"}},children:a.jsx(F,{sx:{width:8,height:8,borderRadius:"50%",backgroundColor:"red"}})})}),a.jsx(ue,{title:t.selection?"Hide selection markers (blue)":"Show selection markers (blue)",placement:"bottom",children:a.jsx(te,{size:"small",onClick:()=>l(r=>({...r,selection:!r.selection})),sx:{p:.25,bgcolor:t.selection?"rgba(70, 130, 180, 0.1)":"transparent",borderRadius:1,"&:hover":{bgcolor:t.selection?"rgba(70, 130, 180, 0.2)":"rgba(0, 0, 0, 0.05)"}},children:a.jsx(F,{sx:{width:8,height:8,borderRadius:"50%",backgroundColor:"rgb(70, 130, 180)"}})})})]}),[E?.figure?.type,t]);return m?ne?a.jsx(L,{windowInstance:m,allFiguresResponse:K,handleDragStart:W,handleDragStop:$,handleResizeStop:I,handleMouseDown:w,handleClose:G,handleAutocompleteChange:N,markerControls:P,children:a.jsx(F,{sx:{flexGrow:1,p:1,overflow:"auto",position:"relative",backgroundColor:"background.paper",display:"flex",justifyContent:"center",alignItems:"center"},children:a.jsx(Ae,{})})}):he?a.jsx(L,{windowInstance:m,allFiguresResponse:K,handleDragStart:W,handleDragStop:$,handleResizeStop:I,handleMouseDown:w,handleClose:G,handleAutocompleteChange:N,markerControls:P,children:a.jsxs(F,{sx:{flexGrow:1,p:1,overflow:"auto",position:"relative",backgroundColor:"background.paper",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"},children:[a.jsx(Ee,{sx:{fontSize:40,mb:1,color:"error.main"}}),a.jsx(X,{variant:"body1",color:"error",children:"Error loading figure."}),a.jsx(X,{variant:"caption",color:"error",children:ye?.message})]})}):E?.figure?E.figure.type==="plotly"&&!ne?a.jsx(L,{windowInstance:m,allFiguresResponse:K,handleDragStart:W,handleDragStop:$,handleResizeStop:I,handleMouseDown:w,handleClose:G,handleAutocompleteChange:N,markerControls:P,children:a.jsx(F,{ref:u,sx:{flexGrow:1,width:"100%",height:"100%",overflow:"auto",position:"relative",backgroundColor:"background.paper"}})}):a.jsx(L,{windowInstance:m,allFiguresResponse:K,handleDragStart:W,handleDragStop:$,handleResizeStop:I,handleMouseDown:w,handleClose:G,handleAutocompleteChange:N,markerControls:P,children:a.jsx(F,{sx:{flexGrow:1,p:1,overflow:"auto",position:"relative",backgroundColor:"background.paper"},children:a.jsx("pre",{style:{margin:0},children:JSON.stringify(E.figure,null,2)})})}):a.jsx(L,{windowInstance:m,allFiguresResponse:K,handleDragStart:W,handleDragStop:$,handleResizeStop:I,handleMouseDown:w,handleClose:G,handleAutocompleteChange:N,markerControls:P,children:a.jsx(F,{sx:{flexGrow:1,p:1,overflow:"auto",position:"relative",backgroundColor:"background.paper"},children:a.jsx(X,{color:"error",children:"No figure data available."})})}):null}const Pe=fe.memo(Ke);export{Pe as default};
